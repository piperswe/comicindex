<!DOCTYPE html>
<html lang="en">
<head>
    <title>comicindex browser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <style>
        .query {
            font-family: monospace;
            width: 100%;
            min-height: 600px;
        }
    </style>
</head>
<body>
<h1>browser</h1>

<div id="app">
    <textarea class="query" v-model="query"></textarea>

    <table class="table">
        <thead>
        <tr>
            <th scope="col" v-for="column in result.columns">{{ column }}</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="row in result.values">
            <td v-for="value in row">
                <a v-if="isURL(value)" v-bind:href="value">{{ value }}</a>
                <a v-else-if="isPhoneNumber(value)" v-bind:href="'tel:' + value">{{ value }}</a>
                <a v-else-if="isEmail(value)" v-bind:href="'mailto:' + value">{{ value }}</a>
                <a v-else-if="isOSM(value)" v-bind:href="osmLink(value)">{{ value }}</a>
                <span v-else>{{ value }}</span></td>
        </tr>
        </tbody>
    </table>

    <h2>Licenses</h2>
    <ul>
        <li v-for="license in licenses">{{ license }}</li>
    </ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/sql.js@1.5.0/dist/sql-wasm.js" integrity="sha256-98ZlNMbPAcX/f3XuDqLRbKuO7Pf9mrspmBpqUuvurZQ=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js" integrity="sha256-KSlsysqp7TXtFo/FHjb1T9b425x3hrvzjMWaJyKbpcI=" crossorigin="anonymous"></script>
<script>
    async function main() {
        const sqlPromise = initSqlJs({
            locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.5.0/dist/${file}`
        });
        const defaultSqlPromise = fetch('default.sql').then(res => res.text());
        const dataPromise = fetch('comic.index').then(res => res.arrayBuffer());
        const [SQL, defaultQuery, buf] = await Promise.all([sqlPromise, defaultSqlPromise, dataPromise]);
        const db = window.db = new SQL.Database(new Uint8Array(buf));
        const app = new Vue({
            el: '#app',
            data: {
                db,
                query: localStorage.getItem('query') || defaultQuery,
            },
            methods: {
                isURL(x) {
                    const re = /(?![^<]*>|[^<>]*<\/)((https?:)\/\/[a-z0-9&#=.\/\-?_]+)/gi;
                    return re.test(x);
                },
                isPhoneNumber(x) {
                    const re = /^\+?[\s\-\d\(\)]{10,}$/;
                    return re.test(x);
                },
                isEmail(x) {
                    const re = /^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$/;
                    return re.test(x);
                },
                isOSM(x) {
                    const re = /^[NWR]\d+$/;
                    return re.test(x);
                },
                osmLink(x) {
                    const chToPath = {
                        N: 'node',
                        W: 'way',
                        R: 'relation',
                    };
                    return `https://openstreetmap.org/${chToPath[x.substring(0, 1)]}/${x.substring(1)}`;
                },
            },
            computed: {
                result() {
                    return this.db.exec(this.query)[0];
                },
                licenses() {
                    return this.db.exec('SELECT license FROM licenses')[0].values.map(x => x[0]);
                },
            },
            watch: {
                query(q) {
                    localStorage.setItem('query', q);
                }
            },
        });
    }

    main();
</script>
</body>
</html>